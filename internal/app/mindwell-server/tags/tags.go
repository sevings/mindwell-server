package tags

import (
	"github.com/go-openapi/runtime/middleware"
	"github.com/leporo/sqlf"
	entriesImpl "github.com/sevings/mindwell-server/internal/app/mindwell-server/entries"
	"github.com/sevings/mindwell-server/models"
	"github.com/sevings/mindwell-server/restapi/operations/entries"
	"github.com/sevings/mindwell-server/restapi/operations/me"
	"github.com/sevings/mindwell-server/restapi/operations/themes"
	"github.com/sevings/mindwell-server/restapi/operations/users"
	"github.com/sevings/mindwell-server/utils"
)

// ConfigureAPI creates operations handlers
func ConfigureAPI(srv *utils.MindwellServer) {
	srv.API.MeGetMeTagsHandler = me.GetMeTagsHandlerFunc(newMyTagsLoader(srv))
	srv.API.UsersGetUsersNameTagsHandler = users.GetUsersNameTagsHandlerFunc(newUserTagsLoader(srv))
	srv.API.ThemesGetThemesNameTagsHandler = themes.GetThemesNameTagsHandlerFunc(newThemeTagsLoader(srv))
	srv.API.EntriesGetEntriesTagsHandler = entries.GetEntriesTagsHandlerFunc(newLiveTagsLoader(srv))
}

func tagsQuery(limit int64) *sqlf.Stmt {
	return sqlf.Select("tags.tag, count(*) AS cnt").
		From("entries").
		Join("entry_tags", "entries.id = entry_tags.entry_id").
		Join("tags", "entry_tags.tag_id = tags.id").
		GroupBy("tags.id").
		Limit(limit)
}

func myTagsQuery(userID *models.UserID, limit int64) *sqlf.Stmt {
	return tagsQuery(limit).
		Where("entries.author_id = ?", userID.ID).
		OrderBy("max(entries.created_at) DESC").
		OrderBy("cnt DESC")
}

func tlogTagsQuery(userID *models.UserID, limit int64, tlog string) *sqlf.Stmt {
	q := tagsQuery(limit).
		Join("entry_privacy", "entries.visible_for = entry_privacy.id").
		Where("entries.author_id = (SELECT id FROM users WHERE lower(name) = lower(?))", tlog).
		OrderBy("max(entries.created_at) DESC").
		OrderBy("cnt DESC")
	entriesImpl.AddRelationToTlogQuery(q, userID, tlog)
	return entriesImpl.AddEntryOpenQuery(q, userID, false)
}

func liveTagsQuery(userID *models.UserID, limit int64) *sqlf.Stmt {
	q := tagsQuery(limit).
		Join("users", "entries.author_id = users.id").
		Join("entry_privacy", "entries.visible_for = entry_privacy.id").
		Join("user_privacy", "users.privacy = user_privacy.id").
		Where("age(entries.created_at) <= interval '1 month'").
		OrderBy("cnt DESC").
		OrderBy("max(entries.created_at) DESC")
	return entriesImpl.AddLiveInvitedQuery(q, userID, "")
}

func loadTags(tx *utils.AutoTx) *models.TagList {
	tags := &models.TagList{}

	var tag string
	var count int64
	for tx.Scan(&tag, &count) {
		item := &models.TagListDataItems0{
			Count: count,
			Tag:   tag,
		}

		tags.Data = append(tags.Data, item)
	}

	return tags
}

func newMyTagsLoader(srv *utils.MindwellServer) func(me.GetMeTagsParams, *models.UserID) middleware.Responder {
	return func(params me.GetMeTagsParams, userID *models.UserID) middleware.Responder {
		return srv.Transact(func(tx *utils.AutoTx) middleware.Responder {
			query := myTagsQuery(userID, *params.Limit)

			tx.QueryStmt(query)
			tags := loadTags(tx)

			return me.NewGetMeTagsOK().WithPayload(tags)
		})
	}
}

func newUserTagsLoader(srv *utils.MindwellServer) func(users.GetUsersNameTagsParams, *models.UserID) middleware.Responder {
	return func(params users.GetUsersNameTagsParams, userID *models.UserID) middleware.Responder {
		return srv.Transact(func(tx *utils.AutoTx) middleware.Responder {
			var query *sqlf.Stmt

			if userID.Name == params.Name {
				query = myTagsQuery(userID, *params.Limit)
			} else {
				if !utils.CanViewTlogName(tx, userID, params.Name) {
					err := srv.StandardError("no_tlog")
					return users.NewGetUsersNameTagsNotFound().WithPayload(err)
				}

				query = tlogTagsQuery(userID, *params.Limit, params.Name)
			}

			tx.QueryStmt(query)
			tags := loadTags(tx)

			return users.NewGetUsersNameTagsOK().WithPayload(tags)
		})
	}
}

func newThemeTagsLoader(srv *utils.MindwellServer) func(themes.GetThemesNameTagsParams, *models.UserID) middleware.Responder {
	return func(params themes.GetThemesNameTagsParams, userID *models.UserID) middleware.Responder {
		return srv.Transact(func(tx *utils.AutoTx) middleware.Responder {
			if !utils.CanViewTlogName(tx, userID, params.Name) {
				err := srv.StandardError("no_tlog")
				return themes.NewGetThemesNameTagsNotFound().WithPayload(err)
			}

			query := tlogTagsQuery(userID, *params.Limit, params.Name)

			tx.QueryStmt(query)
			tags := loadTags(tx)

			return themes.NewGetThemesNameTagsOK().WithPayload(tags)
		})
	}
}

func newLiveTagsLoader(srv *utils.MindwellServer) func(entries.GetEntriesTagsParams, *models.UserID) middleware.Responder {
	return func(params entries.GetEntriesTagsParams, userID *models.UserID) middleware.Responder {
		return srv.Transact(func(tx *utils.AutoTx) middleware.Responder {
			query := liveTagsQuery(userID, *params.Limit)

			tx.QueryStmt(query)
			tags := loadTags(tx)

			return entries.NewGetEntriesTagsOK().WithPayload(tags)
		})
	}
}
